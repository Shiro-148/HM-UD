<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AI Image Recognition Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      text-align: center;
      padding: 20px;
      margin: 0;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Style cho k·∫øt qu·∫£ c√≥ ƒë·ªô tin c·∫≠y th·∫•p */
    .low-confidence {
      color: #e74c3c;
      position: relative;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 70%;
      max-width: 700px;
      margin: auto;
      min-height: 600px;
    }
    input[type=file] {
      margin-top: 20px;
    }
    .btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      padding: 12px 30px;
      font-size: 16px;
      transition: all 0.3s ease;
      border-radius: 50px;
      box-shadow: 0 4px 6px rgba(74, 144, 226, 0.3);
    }
    .btn:disabled {
      background-color: #a0c1e7;
      cursor: not-allowed;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(74, 144, 226, 0.4);
    }
    img {
      margin-top: 20px;
      max-width: 90%;
      max-height: 400px;
      border-radius: 10px;
      object-fit: contain;
    }
    h2 {
      font-size: 28px;
      color: #2c3e50;
    }
    h3 {
      margin-top: 20px;
      color: #333;
    }
    canvas {
      margin-top: 10px;
    }
    .sidebar {
        margin-top: 30px;
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%) translateX(-100%);
      height: 80vh; /* 80% chi·ªÅu cao m√†n h√¨nh */
      width: 300px; /* TƒÉng chi·ªÅu r·ªông */
      background: #4a90e2;
      color: white;
      padding: 25px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      z-index: 1001; /* ƒê·∫£m b·∫£o sidebar hi·ªÉn th·ªã tr√™n c√°c ph·∫ßn t·ª≠ kh√°c */
      overflow: hidden; /* ·∫®n n·ªôi dung v∆∞·ª£t qu√° */
    }
    .sidebar.open {
      transform: translateY(-50%) translateX(0);
    }
    .sidebar h3 {
      margin: 0 0 15px 0;
      position: sticky;
      top: 0;
      background: #4a90e2;
      padding: 5px 0;
      z-index: 2;
    }
    .sidebar-content {
      height: calc(80vh - 80px); /* Chi·ªÅu cao ph·∫ßn content = 80vh - 2*padding - ti√™u ƒë·ªÅ */
      overflow-y: auto;
    }
    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    .sidebar-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    
    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    .sidebar img {
      width: 100%;
      height: 180px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ t·∫°o grid ƒë·∫πp */
      object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh l·∫•p ƒë·∫ßy kh√¥ng gian */
      margin-bottom: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      display: block;
    }
    .sidebar img:hover {
      transform: scale(1.03);
    }
    .toggle-btn {
      position: fixed;
      left: 20px;
      top: 20px;
      background: #4a90e2;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      z-index: 1000;
      font-weight: 500;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .toggle-btn:hover {
      background: #3a7bc8;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    .error-message {
      color: #e74c3c;
      font-weight: 500;
      margin-top: 15px;
      padding: 10px;
      background-color: #fadbd8;
      border-radius: 5px;
      display: none;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }
    .placeholder-img {
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
    }
    #image-container {
    
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    #selected-image {
        max-width: 500px;
      max-height: 450px;
      object-fit: contain;
        border-radius: 10px;
    }
    #result-container {
      margin-top: 30px;
    }
    
    /* CSS cho responsive design */
    @media (max-width: 992px) {
      .container {
        width: 85%;
        padding: 30px;
      }
      .sidebar {
        width: 250px;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        width: 90%;
        padding: 20px;
      }
      body {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <button class="toggle-btn" onclick="toggleSidebar(event)">üìÇ Ch·ªçn ·∫£nh</button>
  <div class="sidebar">
      <h3>B·ªô S∆∞u T·∫≠p ƒê·ªông V·∫≠t</h3>
      <div class="sidebar-content">
        {% for image in images %}
          <img src="{{ url_for('serve_image', filename=image) }}" alt="{{ image }}" onclick="selectImage(this.src)" title="{{ image | replace('.jpg', '') | replace('.jpeg', '') | replace('.png', '') }}">
        {% endfor %}
      </div>
    </div>
    <div class="container">
      <h2>üß† Nh·∫≠n di·ªán c√°c lo√†i ƒë·ªông v·∫≠t</h2>
      <div id="image-container">
        <div class="empty-state">
          <img src="{{ url_for('static', filename='placeholder.svg') }}" alt="Ch·ªçn ·∫£nh" class="placeholder-img" style="opacity: 0.5;">
          <p>üëà Vui l√≤ng ch·ªçn m·ªôt h√¨nh ·∫£nh t·ª´ menu b√™n tr√°i</p>
        </div>
      </div>
      <button class="btn" id="predict-btn" style="display: none;" onclick="predictImage()">üîç Nh·∫≠n di·ªán</button>
      <div id="result-container">
        {% if image_url %}
          <img src="{{ image_url }}" alt="·∫¢nh ƒë∆∞·ª£c nh·∫≠n di·ªán" id="selected-image">
          <h3>K·∫øt qu·∫£: {{ result }}</h3>
          <img src="data:image/png;base64,{{ chart }}" alt="Bi·ªÉu ƒë·ªì ƒë·ªô tin c·∫≠y">
        {% endif %}
      </div>
      <div id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
      </div>
      <div id="error-message" style="display: none;" class="error-message"></div>
        <div class="camera-section">
      <h3>üì∏ Ch·ª•p ·∫£nh tr·ª±c ti·∫øp</h3>
      <video id="camera" width="320" height="240" autoplay></video>
      <br>
      <button type="button" onclick="capturePhoto()">Ch·ª•p ·∫£nh</button>
      <canvas id="snapshot" width="320" height="240" style="display:none;"></canvas>
    </div>

  </div>




  <script>
    function toggleSidebar(event) {
      if (event) {
        event.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ƒë·∫øn document
      }
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('open');
    }
    
    // H√†m ƒë√≥ng sidebar khi click b√™n ngo√†i
    document.addEventListener('mousedown', function(event) {
      const sidebar = document.querySelector('.sidebar');
      const toggleBtn = document.querySelector('.toggle-btn');
      
      // Ki·ªÉm tra xem sidebar c√≥ ƒëang m·ªü kh√¥ng v√† click kh√¥ng ph·∫£i ·ªü sidebar ho·∫∑c n√∫t toggle
      if (sidebar.classList.contains('open') && 
          !sidebar.contains(event.target) && 
          event.target !== toggleBtn &&
          !toggleBtn.contains(event.target)) {
        sidebar.classList.remove('open');
      }
    });
    
    let selectedImagePath = '';
    
    // H√†m kh·ªüi t·∫°o trang web
    document.addEventListener('DOMContentLoaded', function() {
      // T·∫°o placeholder SVG
      createPlaceholderSVG();
      
      // NgƒÉn kh√¥ng cho s·ª± ki·ªán click lan t·ª´ sidebar ra ngo√†i
      const sidebar = document.querySelector('.sidebar');
      sidebar.addEventListener('click', function(event) {
        event.stopPropagation();
      });
    });
    
    // T·∫°o SVG placeholder n·∫øu ch∆∞a t·ªìn t·∫°i
    function createPlaceholderSVG() {
      fetch('/static/placeholder.svg')
        .then(response => {
          if (response.status === 404) {
            const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M20.4 14.5L16 10 4 20"/></svg>`;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const placeholderImg = document.querySelector('.placeholder-img');
            if (placeholderImg) {
              placeholderImg.src = URL.createObjectURL(blob);
            }
          }
        });
    }
    
    function selectImage(imageSrc) {
      try {
        // L∆∞u ƒë∆∞·ªùng d·∫´n c·ªßa ·∫£nh ƒë√£ ch·ªçn
        selectedImagePath = imageSrc;
        
        // X√≥a n·ªôi dung c≈© trong container
        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';
        
        // T·∫°o v√† th√™m h√¨nh ·∫£nh m·ªõi
        const previewImage = document.createElement('img');
        previewImage.src = imageSrc;
        previewImage.id = 'selected-image';
        previewImage.onerror = function() {
          showError("Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh. Vui l√≤ng ch·ªçn l·∫°i.");
          imageContainer.innerHTML = '<div class="empty-state"><p>L·ªói t·∫£i ·∫£nh, vui l√≤ng ch·ªçn l·∫°i.</p></div>';
          selectedImagePath = '';
          document.getElementById('predict-btn').style.display = 'none';
        };
        
        // Th√™m ·∫£nh m·ªõi v√†o container
        imageContainer.appendChild(previewImage);
        
        // ƒê√≥ng sidebar sau khi ch·ªçn ·∫£nh
        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
        }
        
        // Hi·ªÉn th·ªã n√∫t nh·∫≠n di·ªán
        document.getElementById('predict-btn').style.display = 'inline-block';
        
        // X√≥a k·∫øt qu·∫£ nh·∫≠n di·ªán c≈©
        clearResults();
        
        // ·∫®n th√¥ng b√°o l·ªói n·∫øu c√≥
        hideError();
        
        // T·ª± ƒë·ªông ƒë√≥ng sidebar tr√™n thi·∫øt b·ªã di ƒë·ªông
        if (window.innerWidth < 768) {
          toggleSidebar();
        }
      } catch (error) {
        console.error('L·ªói khi ch·ªçn ·∫£nh:', error);
        showError('ƒê√£ x·∫£y ra l·ªói khi ch·ªçn ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }
    
    function clearResults() {
      const resultContainer = document.getElementById('result-container');
      resultContainer.innerHTML = '';
    }
    
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('predict-btn').disabled = true;
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('predict-btn').disabled = false;
    }
    
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }
    
    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }
    
    function predictImage() {
      if (!selectedImagePath) {
        showError('Vui l√≤ng ch·ªçn m·ªôt h√¨nh ·∫£nh tr∆∞·ªõc!');
        return;
      }
      
      // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω
      showLoading();
      clearResults();
      
      // G·ª≠i y√™u c·∫ßu nh·∫≠n di·ªán ƒë·∫øn server
      fetch('/predict', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image_path: selectedImagePath })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`M√£ l·ªói HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        hideLoading();
        
        if (!data.success) {
          showError(data.error || 'C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh nh·∫≠n di·ªán.');
          return;
        }
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        const resultContainer = document.getElementById('result-container');
        
        const resultHeader = document.createElement('h3');
        resultHeader.textContent = `K·∫øt qu·∫£: ${data.result}`;
        
        // Th√™m class n·∫øu d∆∞·ªõi ng∆∞·ª°ng tin c·∫≠y
        if (data.below_threshold) {
          resultHeader.classList.add('low-confidence');
        }
        
        resultContainer.appendChild(resultHeader);
        
        const confidenceElement = document.createElement('p');
        confidenceElement.textContent = `ƒê·ªô tin c·∫≠y: ${data.confidence}`;
        resultContainer.appendChild(confidenceElement);
        
        const chartImg = document.createElement('img');
        chartImg.src = `data:image/png;base64,${data.chart}`;
        chartImg.alt = 'Bi·ªÉu ƒë·ªì ƒë·ªô tin c·∫≠y';
        resultContainer.appendChild(chartImg);
      })
      .catch(error => {
        console.error('L·ªói:', error);
        hideLoading();
        showError(`C√≥ l·ªói x·∫£y ra khi nh·∫≠n di·ªán: ${error.message}`);
      });
    }

      const video = document.getElementById('camera');
  const canvas = document.getElementById('snapshot');
  const context = canvas.getContext('2d');

  // B·∫≠t camera
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(err => alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err));

  // H√†m ch·ª•p ·∫£nh
  function capturePhoto() {
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/png');

    fetch('/capture', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageData })
    })
    .then(res => res.json())
    .then(data => {
      const resultContainer = document.getElementById('result-container');
      resultContainer.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©

      if (data.success) {
        resultContainer.innerHTML = `
          <h3>K·∫øt qu·∫£: ${data.result}</h3>
          <p>ƒê·ªô tin c·∫≠y: ${data.confidence}</p>
          <img src="data:image/png;base64,${data.chart}" alt="Bi·ªÉu ƒë·ªì ƒë·ªô tin c·∫≠y">
        `;
      } else {
        showError(data.error || 'L·ªói khi nh·∫≠n di·ªán ·∫£nh ch·ª•p.');
      }
    })
    .catch(err => showError('Kh√¥ng th·ªÉ g·ª≠i ·∫£nh: ' + err));
  }

  </script>
</body>
</html>
